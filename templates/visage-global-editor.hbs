<div class="visage-editor-container">
    <p class="visage-notes">{{localize "VISAGE.GlobalEditor.Hint"}}</p>

    <div class="visage-editor-grid">
        
        {{!-- COLUMN 1: IDENTITY & PREVIEW --}}
        <div class="visage-column metadata">
            
            <h3 class="column-header">{{localize "VISAGE.GlobalEditor.Col.Preview"}}</h3>
            
            <div class="visage-live-preview-stage">
                {{!-- REUSING VISAGE CARD STRUCTURE --}}
                <div class="visage-card">
                    <div class="card-body">
                        
                        {{!-- ZONE 1: METADATA (Left) --}}
                        <div class="card-zone-left">
                            <div class="metadata-slot scale-slot {{#unless preview.slots.scale.active}}inactive{{/unless}}" 
                                 data-tooltip="{{localize 'VISAGE.Directory.Tooltip.Scale'}}">
                                <i class="fas fa-ruler-combined"></i>
                                <span class="slot-value">{{preview.slots.scale.val}}</span>
                            </div>

                            <div class="metadata-slot dim-slot {{#unless preview.slots.dim.active}}inactive{{/unless}}"
                                 data-tooltip="{{localize 'VISAGE.Directory.Tooltip.Dimensions'}}">
                                <i class="fas fa-vector-square"></i>
                                <span class="slot-value">{{preview.slots.dim.val}}</span>
                            </div>

                            <div class="metadata-slot flip-slot {{#unless preview.slots.flip.active}}inactive{{/unless}}"
                                 data-tooltip="{{localize 'VISAGE.Directory.Tooltip.Orientation'}}">
                                <i class="{{preview.slots.flip.icon}}"></i>
                                <span class="slot-value">{{preview.slots.flip.val}}</span>
                            </div>

                            <div class="metadata-slot disposition-slot">
                                <div class="visage-disposition-chip {{preview.slots.disposition.class}}">
                                    {{preview.slots.disposition.val}}
                                </div>
                            </div>
                        </div>

                        {{!-- ZONE 2: VISUAL PREVIEW (Center) --}}
                        <div class="card-zone-center">
                            <div class="visual-target">
                                <div class="visage-preview-content">
                                    {{!-- RING PREVIEW --}}
                                    {{!-- Note: Inline styles handle the live updates for display and CSS variables --}}
                                    <div class="visage-ring-preview {{#if preview.hasPulse}}pulse{{/if}} {{#if preview.hasGradient}}gradient{{/if}} {{#if preview.hasWave}}wave{{/if}}" 
                                         style="display: {{#if preview.hasRing}}block{{else}}none{{/if}}; --ring-color: {{preview.ringColor}}; --ring-bkg: {{preview.ringBkg}};">
                                         <div class="ring-band outer"></div>
                                         <div class="ring-band inner"></div>
                                    </div>

                                    {{!-- MEDIA PREVIEW --}}
                                    <video class="visage-preview-video" 
                                           src="{{#if preview.isVideo}}{{preview.img}}{{/if}}" 
                                           autoplay loop muted playsinline 
                                           style="display: {{#if preview.isVideo}}block{{else}}none{{/if}}; transform: scale({{#if preview.flipX}}-1{{else}}1{{/if}}, {{#if preview.flipY}}-1{{else}}1{{/if}});">
                                    </video>

                                    <img class="visage-preview-img" 
                                         src="{{#unless preview.isVideo}}{{preview.img}}{{/unless}}" 
                                         style="display: {{#if (and preview.img (not preview.isVideo))}}block{{else}}none{{/if}}; transform: scale({{#if preview.flipX}}-1{{else}}1{{/if}}, {{#if preview.flipY}}-1{{else}}1{{/if}});">

                                    <i class="visage-icon-mask fallback-icon" 
                                       style="display: {{#if preview.img}}none{{else}}block{{/if}};"></i>
                                </div>
                            </div>
                            <div class="token-name-label">{{preview.name}}</div>
                        </div>

                        {{!-- ZONE 3: ACTIONS (Right) - Empty but structurally necessary --}}
                        <div class="card-zone-right"></div>
                    </div>

                    {{!-- FOOTER --}}
                    <div class="card-footer">
                        <h4 class="card-title">{{label}}</h4>
                        <div class="card-tags">
                            {{#each preview.tagList}}
                            <span class="tag">{{this}}</span>
                            {{/each}}
                        </div>
                    </div>
                </div>
            </div>

            {{!-- B. IDENTITY INPUTS --}}
            <h3 class="column-header">{{localize "VISAGE.GlobalEditor.Col.Identity"}}</h3>
            <fieldset class="visage-config-fieldset">
                <div class="form-group">
                    <label>{{localize "VISAGE.GlobalEditor.Label"}}</label>
                    <div class="form-fields">
                        <input type="text" name="label" value="{{label}}" placeholder="e.g. Ancient Red Dragon">
                    </div>
                    <p class="hint">{{localize "VISAGE.GlobalEditor.LabelHint"}}</p>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.GlobalEditor.Category"}}</label>
                    <div class="form-fields">
                        <input type="text" name="category" value="{{category}}" list="visage-categories" placeholder="{{localize 'VISAGE.GlobalEditor.CategoryPlaceholder'}}">
                        <datalist id="visage-categories">
                            {{#each categories}}
                            <option value="{{this}}"></option>
                            {{/each}}
                        </datalist>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.GlobalEditor.Tags"}}</label>
                    <div class="form-fields">
                        <input type="text" name="tags" value="{{tags}}" placeholder="boss, fire, huge">
                    </div>
                    <p class="hint">{{localize "VISAGE.GlobalEditor.TagsHint"}}</p>
                </div>
            </fieldset>
        </div>

        {{!-- COLUMN 2: TOKEN DATA --}}
        <div class="visage-column token-data">
            <h3 class="column-header">{{localize "VISAGE.GlobalEditor.Col.Appearance"}}</h3>
            
            <fieldset class="visage-config-fieldset">
                {{!-- 1. Name Override --}}
                <div class="form-group checkbox-input-group">
                    <input type="checkbox" name="nameOverride_active" data-action="toggleField" data-target="nameOverride" {{checked nameOverride.active}} data-tooltip="{{localize 'VISAGE.GlobalEditor.OverrideTooltip'}}">
                    <div class="form-fields">
                        <input type="text" name="nameOverride" value="{{nameOverride.value}}" {{disabled (not nameOverride.active)}} placeholder="{{localize 'VISAGE.GlobalEditor.NameOverride'}}">
                    </div>
                </div>

                {{!-- 2. Image --}}
                <div class="form-group checkbox-input-group">
                    <input type="checkbox" name="img_active" data-action="toggleField" data-target="img" {{checked img.active}} data-tooltip="{{localize 'VISAGE.GlobalEditor.OverrideTooltip'}}">
                    <div class="form-fields">
                        {{!-- REUSE: VISAGE.Config.Placeholder.Path --}}
                        <input type="text" name="img" value="{{img.value}}" {{disabled (not img.active)}} placeholder="{{localize 'VISAGE.Config.Placeholder.Path'}}">
                        <button type="button" class="file-picker-button" data-action="openFilePicker" {{disabled (not img.active)}}><i class="fas fa-file-import"></i></button>
                    </div>
                </div>

                {{!-- 3. Scale (%) --}}
                <div class="form-group checkbox-input-group">
                    <input type="checkbox" name="scale_active" data-action="toggleField" data-target="scale" {{checked scale.active}} data-tooltip="{{localize 'VISAGE.GlobalEditor.OverrideTooltip'}}">
                    {{!-- REUSE: VISAGE.Config.List.Scale --}}
                    <label>{{localize "VISAGE.Config.List.Scale"}}</label>
                    <div class="form-fields">
                        <input type="number" name="scale" value="{{scale.value}}" step="1" {{disabled (not scale.active)}}>
                    </div>
                </div>

                {{!-- 4. Flips (Vertical Stack) --}}
                <div class="form-group checkbox-input-group">
                    <label style="grid-column: 1 / span 3; margin-bottom: 0.25rem;">{{localize "VISAGE.GlobalEditor.Mirroring"}}</label>
                    
                    <div class="form-fields stacked-selects" style="grid-column: 1 / span 3;">
                        
                        {{!-- Horizontal X --}}
                        <select name="isFlippedX">
                            <option value="" {{visageSelected (eq isFlippedX.value null)}}>{{localize "VISAGE.Mirror.Horizontal.Unchanged"}}</option>
                            <option value="false" {{visageSelected (eq isFlippedX.value false)}}>{{localize "VISAGE.Mirror.Horizontal.Standard"}}</option>
                            <option value="true" {{visageSelected (eq isFlippedX.value true)}}>{{localize "VISAGE.Mirror.Horizontal.Mirrored"}}</option>
                        </select>

                        {{!-- Vertical Y --}}
                        <select name="isFlippedY">
                            <option value="" {{visageSelected (eq isFlippedY.value null)}}>{{localize "VISAGE.Mirror.Vertical.Unchanged"}}</option>
                            <option value="false" {{visageSelected (eq isFlippedY.value false)}}>{{localize "VISAGE.Mirror.Vertical.Standard"}}</option>
                            <option value="true" {{visageSelected (eq isFlippedY.value true)}}>{{localize "VISAGE.Mirror.Vertical.Mirrored"}}</option>
                        </select>
                    </div>
                    
                    <p class="hint" style="grid-column: 1 / span 3;">{{localize "VISAGE.GlobalEditor.MirrorHint"}}</p>
                </div>

                {{!-- 5. Disposition --}}
                <div class="form-group checkbox-input-group">
                    <input type="checkbox" name="disposition_active" data-action="toggleField" data-target="disposition" {{checked disposition.active}} data-tooltip="{{localize 'VISAGE.GlobalEditor.OverrideTooltip'}}">
                    <div class="form-fields">
                        <select name="disposition" {{disabled (not disposition.active)}}>
                            {{!-- REUSE: Existing Disposition Keys --}}
                            <option value="1" {{visageSelected (eq disposition.value 1)}}>{{localize "VISAGE.Disposition.Friendly"}}</option>
                            <option value="0" {{visageSelected (eq disposition.value 0)}}>{{localize "VISAGE.Disposition.Neutral"}}</option>
                            <option value="-1" {{visageSelected (eq disposition.value -1)}}>{{localize "VISAGE.Disposition.Hostile"}}</option>
                            <option value="-2" {{visageSelected (eq disposition.value -2)}}>{{localize "VISAGE.Disposition.Secret"}}</option>
                        </select>
                    </div>
                </div>

                {{!-- 6. Dimensions --}}
                <div class="form-group checkbox-input-group">
                    <input type="checkbox" name="width_active" data-action="toggleField" data-target="width" {{checked width.active}} data-tooltip="{{localize 'VISAGE.GlobalEditor.OverrideTooltip'}}">
                    {{!-- REUSE: VISAGE.Config.List.Width --}}
                    <label>{{localize "VISAGE.Config.List.Width"}}</label>
                    <input type="number" name="width" value="{{width.value}}" {{disabled (not width.active)}}>
                </div>
                <div class="form-group checkbox-input-group">
                    <input type="checkbox" name="height_active" data-action="toggleField" data-target="height" {{checked height.active}} data-tooltip="{{localize 'VISAGE.GlobalEditor.OverrideTooltip'}}">
                    {{!-- REUSE: VISAGE.Config.List.Height --}}
                    <label>{{localize "VISAGE.Config.List.Height"}}</label>
                    <input type="number" name="height" value="{{height.value}}" {{disabled (not height.active)}}>
                </div>
            </fieldset>
        </div>

        {{!-- COLUMN 3: DYNAMIC RING --}}
        <div class="visage-column ring-data">
            <h3 class="column-header">{{localize "VISAGE.GlobalEditor.Col.Ring"}}</h3>
            
            <fieldset class="visage-config-fieldset">
                <div class="form-group">
                    <label class="master-toggle">
                        <input type="checkbox" name="ring.enabled" {{checked ring.active}}>
                        {{localize "VISAGE.GlobalEditor.RingEnable"}}
                    </label>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.RingColor"}}</label>
                    <div class="form-fields">
                        <color-picker name="ringColor" value="{{ring.colors.ring}}"></color-picker>
                    </div>
                </div>
                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.BackgroundColor"}}</label>
                    <div class="form-fields">
                        <color-picker name="ringBackgroundColor" value="{{ring.colors.background}}"></color-picker>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.SubjectTexture"}}</label>
                    <div class="form-fields">
                        <file-picker type="image" name="ringSubjectTexture" value="{{ring.subject.texture}}"></file-picker>
                    </div>
                </div>
                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.SubjectScale"}}</label>
                    <div class="form-fields">
                        <range-picker name="ringSubjectScale" value="{{ring.subject.scale}}" min="0.5" max="3.0" step="0.1"></range-picker>
                    </div>
                </div>

                <div class="form-group stacked">
                    <label>{{localize "VISAGE.RingConfig.Effects.Label"}}</label>
                    <div class="form-fields effects-grid">
                        {{#each ring.effects}}
                        <label class="checkbox">
                            <input type="checkbox" name="effect_{{this.value}}" {{checked this.isActive}}>
                            {{localize this.label}}
                        </label>
                        {{/each}}
                    </div>
                </div>

            </fieldset>
        </div>

    </div>

    <footer class="visage-config-footer">
        <button type="submit" class="visage-save {{#if isDirty}}dirty{{/if}}" data-action="save">
            <i class="fas fa-save"></i> {{localize "VISAGE.GlobalEditor.Save"}}
        </button>
    </footer>
</div>