{{!-- modules/visage/templates/visage-editor.hbs --}}
<div class="visage-editor-container workstation-layout">
    
    {{!-- 1. GLOBAL HEADER --}}
    <header class="visage-editor-header">
        
        {{!-- Label Group --}}
        <div class="header-form-group label-group">
            <label>{{localize "VISAGE.GlobalEditor.Label"}}</label>
            <input type="text" name="label" value="{{label}}" placeholder="{{localize 'VISAGE.GlobalEditor.DefaultLabel'}}" required>
        </div>

        {{!-- Visibility Group (Global Only) --}}
        {{#unless isLocal}}
        <div class="header-form-group visibility-group">
            <label>{{localize "VISAGE.GlobalEditor.Visibility"}}</label>
            <div class="visage-mode-toggle">
                <input type="radio" name="public" id="visibility-private-{{appId}}" value="false" {{checked (not isPublic)}}>
                <label for="visibility-private-{{appId}}" data-tooltip="VISAGE.GlobalEditor.VisibilityPrivateHint">
                    <i class="visage-icon private"></i> {{localize "VISAGE.GlobalEditor.Private"}}
                </label>

                <input type="radio" name="public" id="visibility-public-{{appId}}" value="true" {{checked isPublic}}>
                <label for="visibility-public-{{appId}}" data-tooltip="VISAGE.GlobalEditor.VisibilityPublicHint">
                    <i class="visage-icon public"></i> {{localize "VISAGE.GlobalEditor.Public"}}
                </label>
            </div>
        </div>
        {{/unless}}

        {{!-- Mode Group --}}
        <div class="header-form-group mode-group">
            <label>{{localize "VISAGE.GlobalEditor.Mode"}}</label>
            <div class="visage-mode-toggle">
                <input type="radio" name="mode" id="mode-identity-{{appId}}" value="identity" {{checked (visageEq mode "identity")}}>
                <label for="mode-identity-{{appId}}" data-tooltip="VISAGE.Mode.IdentityHint">
                    {{localize "VISAGE.Mode.Identity"}}
                </label>

                <input type="radio" name="mode" id="mode-overlay-{{appId}}" value="overlay" {{checked (visageEq mode "overlay")}}>
                <label for="mode-overlay-{{appId}}" data-tooltip="VISAGE.Mode.OverlayHint">
                    {{localize "VISAGE.Mode.Overlay"}}
                </label>
            </div>
        </div>
        
        {{!-- Category Group --}}
        <div class="header-form-group category-group">
            <label>{{localize "VISAGE.GlobalEditor.Category"}}</label>
            <input type="text" name="category" value="{{category}}" list="visage-categories" placeholder="{{localize 'VISAGE.GlobalEditor.CategoryPlaceholder'}}">
            <datalist id="visage-categories">
                {{#each categories}}
                <option value="{{this}}"></option>
                {{/each}}
            </datalist>
        </div>

        {{!-- Tags Group --}}
        <div class="header-form-group tags-group">
            <label>{{localize "VISAGE.GlobalEditor.Tags"}}</label>
            <div class="visage-tag-container compact">
                <div class="visage-tag-pills">
                    {{!-- Pills injected by JS --}}
                </div>
                <input type="text" class="visage-tag-input" list="visage-all-tags" placeholder="{{localize 'VISAGE.GlobalEditor.TagsHint'}}">
                <input type="hidden" name="tags" value="{{tagsString}}">
            </div>
            <datalist id="visage-all-tags">
                {{#each allTags}}
                <option value="{{this}}"></option>
                {{/each}}
            </datalist>
        </div>

    </header>

    <div class="visage-workstation">
        
        {{!-- 2. LEFT PANEL: STAGE & STATS --}}
        <div class="visage-stage-panel">
            
            {{!-- A. THE STAGE --}}
            <div class="visage-live-preview-stage">
                {{> "modules/visage/templates/parts/visage-preview.hbs" 
                    resolvedPath=preview.img 
                    name=preview.name
                    hasCheckerboard=true
                    alpha=preview.alpha
                    isVideo=preview.isVideo
                    
                    hasRing=preview.hasRing 
                    hasInvisibility=preview.hasInvisibility
                    hasPulse=preview.hasPulse
                    hasGradient=preview.hasGradient
                    hasWave=preview.hasWave
                    ringColor=preview.ringColor
                    ringBkg=preview.ringBkg
                    
                    hasLight=preview.hasLight
                    lightColor=preview.lightColor
                    lightDim=preview.lightDim
                    lightBright=preview.lightBright
                    
                    forceFlipX=preview.flipX
                    forceFlipY=preview.flipY
                    wrapperClass="visage-preview-content stage-mode"
                }}
                 
                <div class="stage-overlay-name">{{preview.name}}</div>
                <div class="visage-stage-hint">{{localize "VISAGE.Editor.StageHint"}}</div>

                {{!-- Stage Controls HUD --}}
                <div class="visage-zoom-controls">
                    <button type="button" data-action="toggleGrid" data-tooltip="{{localize 'VISAGE.Editor.ToggleGrid'}}">
                        <i class="visage-icon grid-on"></i>
                    </button>
                    <div class="visage-divider-vertical" style="width:1px; background:rgba(255,255,255,0.1); margin: 0 4px;"></div>
                    <button type="button" data-action="zoomOut" data-tooltip="{{localize 'VISAGE.Editor.ZoomOut'}}">
                        <i class="visage-icon zoom-out"></i>
                    </button>
                    <button type="button" data-action="resetZoom" data-tooltip="{{localize 'VISAGE.Editor.ResetView'}}">
                        <i class="visage-icon center-focus"></i>
                    </button>
                    <button type="button" data-action="zoomIn" data-tooltip="{{localize 'VISAGE.Editor.ZoomIn'}}">
                        <i class="visage-icon zoom-in"></i>
                    </button>
                    <div class="visage-divider-vertical" style="width:1px; background:rgba(255,255,255,0.1); margin: 0 4px;"></div>
                    <button type="button" data-action="replayPreview" data-tooltip="{{localize 'VISAGE.Editor.Replay'}}">
                        <i class="visage-icon refresh"></i>
                    </button>
                </div>
            </div>

            {{!-- B. METADATA GRID --}}
            <div class="metadata-grid">
                {{!-- Row 1: Scale --}}
                <div class="meta-item {{#unless preview.slots.scale.active}}inactive{{/unless}}">
                    <i class="visage-icon scale"></i>
                    <span class="meta-label">{{localize 'VISAGE.Directory.Tooltip.Scale'}}:</span>
                    <span class="meta-value">{{preview.slots.scale.val}}</span>
                </div>

                {{!-- Row 1: Dimensions --}}
                <div class="meta-item {{#unless preview.slots.dim.active}}inactive{{/unless}}">
                    <i class="visage-icon dimensions"></i>
                    <span class="meta-label">{{localize 'VISAGE.Config.List.Width'}}/{{localize 'VISAGE.Config.List.Height'}}:</span>
                    <span class="meta-value">{{preview.slots.dim.val}}</span>
                </div>
                
                {{!-- Row 2: Rotation Lock --}}
                <div class="meta-item {{#unless preview.slots.lock.active}}inactive{{/unless}}">
                    <i class="visage-icon lock"></i>
                    <span class="meta-label">{{localize 'VISAGE.RotationLock.Label'}}:</span>
                    <span class="meta-value">{{preview.slots.lock.val}}</span>
                </div>

                {{!-- Row 2: Wildcard --}}
                <div class="meta-item {{#unless preview.slots.wildcard.active}}inactive{{/unless}}">
                    <i class="visage-icon wildcard"></i>
                    <span class="meta-label">{{localize 'VISAGE.Wildcard.Label'}}:</span>
                    <span class="meta-value">{{preview.slots.wildcard.val}}</span>
                </div>

                {{!-- Row 3: Disposition --}}
                <div class="meta-item disposition-item">
                     <i class="visage-icon domino"></i>
                     <span class="meta-label">{{localize "VISAGE.Disposition.Label"}}:</span>
                     <span class="visage-disposition-text {{preview.slots.disposition.class}}">{{preview.slots.disposition.val}}</span>
                </div>

                {{!-- Row 3: Mirroring --}}
                <div class="meta-item mirror-split">
                    <div class="mirror-sub-slot horizontal {{#unless preview.slots.flipH.active}}inactive{{/unless}}" title="{{localize 'VISAGE.Mirror.Horizontal.Label'}}">
                        <img src="{{preview.slots.flipH.src}}" class="visage-icon-nav {{preview.slots.flipH.cls}}"/>
                        <span class="meta-value">{{localize "VISAGE.Mirror.Badge.H"}}</span>
                    </div>
                    <div class="mirror-sub-slot vertical {{#unless preview.slots.flipV.active}}inactive{{/unless}}" title="{{localize 'VISAGE.Mirror.Vertical.Label'}}">
                        <img src="{{preview.slots.flipV.src}}" class="visage-icon-nav {{preview.slots.flipV.cls}}"/>
                        <span class="meta-value">{{localize "VISAGE.Mirror.Badge.V"}}</span>
                    </div>
                </div>
            </div>
        </div>

        {{!-- 3. RIGHT PANEL: INSPECTOR --}}
        <div class="visage-inspector-panel">
            
            {{!-- TABS NAVIGATION --}}
            <nav class="visage-tabs tabs" aria-label="{{localize 'VISAGE.NavLabel'}}">
                <a class="item active" data-tab="appearance">{{localize "VISAGE.Editor.Tabs.Appearance"}}</a>
                <a class="item" data-tab="effects">{{localize "VISAGE.Editor.Tabs.Effects"}}</a>
                <a class="item" data-tab="triggers">{{localize "VISAGE.Editor.Tabs.Triggers"}}</a>
            </nav>

            {{!-- TAB CONTENT --}}
            <section class="visage-tab-content visage-scrollable">
                
                {{!-- TAB 1: APPEARANCE --}}
                {{> "modules/visage/templates/parts/visage-editor-appearance.hbs"}}

                {{!-- TAB 2: EFFECTS (Combined Visual, Audio, Light, Ring) --}}
                {{> "modules/visage/templates/parts/visage-editor-effects.hbs"}}

                {{!-- TAB 3: TRIGGERS --}}
                {{> "modules/visage/templates/parts/visage-editor-triggers.hbs"}}

            </section>
        </div>

    </div>

    {{!-- FOOTER --}}
    <footer class="visage-editor-footer">
        {{#if isLocal}}
        <button type="button" class="visage-reset-btn" data-action="resetSettings" data-tooltip="{{localize 'VISAGE.GlobalEditor.ResetTooltip'}}">
            <i class="visage-icon undo"></i> {{localize "VISAGE.GlobalEditor.Reset"}}
        </button>
        {{/if}}

        <button type="submit" class="visage-save {{#if isDirty}}dirty{{/if}}" data-action="save">
            <i class="visage-icon save-update"></i> 
            {{#if isLocal}}
                {{localize "VISAGE.GlobalEditor.Save.Local"}}
            {{else}}
                {{localize "VISAGE.GlobalEditor.Save.Global"}}
            {{/if}}
        </button>
    </footer>
</div>