<div class="tab effects-tab-container {{#if inspector.type}}editing{{/if}}" data-tab="effects" data-group="primary">
    
    {{!-- VIEW 1: THE STACK LIST --}}
    <div class="visage-view view-list">

        {{#if hasSequencer}}
        <div class="effects-actions">
            <button type="button" data-action="addVisual">
                <i class="visage-icon visual"></i> {{localize "VISAGE.Editor.Effects.AddVisual"}}
            </button>
            <button type="button" data-action="addAudio">
                <i class="visage-icon audio"></i> {{localize "VISAGE.Editor.Effects.AddAudio"}}
            </button>
        </div>
        {{/if}}

        <div class="visage-effect-list visage-scrollable">
            
            {{!-- 1. Dynamic Ring Card (Pinned) --}}
            <div class="effect-group" data-group="ring">
                 <h3 class="group-header sticky">
                    <i class="visage-icon ring"></i> {{localize "VISAGE.Editor.Tabs.Ring"}}
                </h3>
                <div class="effect-card pinned-light {{#if ring.active}}active{{else}}visage-disabled{{/if}}" data-action="editRing">
                    <div class="effect-info">
                        <span class="effect-name">{{localize "VISAGE.Editor.Tabs.Ring"}}</span>
                        <span class="effect-meta">
                            {{#if (not ring.active)}}
                                {{localize "VISAGE.GlobalEditor.RingDisabled"}}
                            {{/if}}
                        </span>
                    </div>
                    <div class="effect-controls">
                        <button type="button" class="effect-btn toggle-visibility" data-action="toggleRing">
                            <i class="visage-icon {{#if (not ring.active)}}visage-hidden{{else}}visible{{/if}}"></i>
                        </button>
                    </div>
                </div>
            </div>

            {{!-- 2. Light Source Card (Pinned) --}}
            <div class="effect-group" data-group="light">
                 <h3 class="group-header sticky">
                    <i class="visage-icon light"></i> {{localize "VISAGE.Editor.Groups.LightSource"}}
                </h3>
                <div class="effect-card pinned-light {{#if light.active}}active{{else}}visage-disabled{{/if}}" data-action="editLight">
                    <div class="effect-info">
                        <span class="effect-name">{{localize "VISAGE.Editor.Light.Title"}}</span>
                        <span class="effect-meta">
                            {{#if light.active}}
                                <span>{{localize "VISAGE.Light.Meta.Dim"}}&nbsp;{{light.dim}}&nbsp;/&nbsp;{{localize "VISAGE.Light.Meta.Bright"}}&nbsp;{{light.bright}}</span>
                                {{#if light.animation.type}}
                                    <span>&nbsp;•&nbsp;{{light.localizedAnimation}}</span>
                                {{/if}}
                                <span class="visage-color-dot" style="background-color: {{light.color}};" title="{{light.color}}"></span>
                            {{else}}
                                {{localize "VISAGE.Editor.Light.Disabled"}}
                            {{/if}}
                        </span>
                    </div>
                    <div class="effect-controls">
                        <button type="button" class="effect-btn toggle-visibility" data-action="toggleLight">
                            <i class="visage-icon {{#if (not light.active)}}visage-hidden{{else}}visible{{/if}}"></i>
                        </button>
                    </div>
                </div>
            </div>

            {{!-- 3. Sequencer Content --}}
            {{#if hasSequencer}}
                {{#if inspector.hasEffects}}
                    {{!-- Foreground --}}
                    <div class="effect-group" data-group="above">
                        <h3 class="group-header sticky">
                            <i class="visage-icon visual"></i> {{localize "VISAGE.Editor.Groups.Foreground"}}
                        </h3>
                        <div class="group-drop-zone">
                            {{#each inspector.effectsAbove}}
                                {{> "modules/visage/templates/parts/visage-effectCard.hbs" this activeId=../activeId inspector=../inspector}}
                            {{/each}}
                            {{#unless inspector.effectsAbove.length}}
                                <div class="empty-group-placeholder">{{localize "VISAGE.Editor.Groups.Empty"}}</div>
                            {{/unless}}
                        </div>
                    </div>

                    {{!-- Background --}}
                    <div class="effect-group" data-group="below">
                        <h3 class="group-header sticky">
                            <i class="visage-icon visual"></i> {{localize "VISAGE.Editor.Groups.Background"}}
                        </h3>
                        <div class="group-drop-zone">
                            {{#each inspector.effectsBelow}}
                                {{> "modules/visage/templates/parts/visage-effectCard.hbs" this activeId=../activeId inspector=../inspector}}
                            {{/each}}
                            {{#unless inspector.effectsBelow.length}}
                                <div class="empty-group-placeholder">{{localize "VISAGE.Editor.Groups.Empty"}}</div>
                            {{/unless}}
                        </div>
                    </div>

                    {{!-- Audio --}}
                    <div class="effect-group" data-group="audio">
                        <h3 class="group-header sticky">
                            <i class="visage-icon audio"></i> {{localize "VISAGE.Editor.Groups.Audio"}}
                        </h3>
                        <div class="group-drop-zone">
                            {{#each inspector.effectsAudio}}
                                {{> "modules/visage/templates/parts/visage-effectCard.hbs" this activeId=../activeId inspector=../inspector}}
                            {{/each}}
                            {{#unless inspector.effectsAudio.length}}
                                <div class="empty-group-placeholder">{{localize "VISAGE.Editor.Groups.Empty"}}</div>
                            {{/unless}}
                        </div>
                    </div>
                {{else}}
                    <div class="empty-placeholder">
                        <i class="visage-icon wand-stars"></i>
                        <p>{{localize "VISAGE.Editor.Effects.Empty"}}</p>
                    </div>
                {{/if}}
            {{else}}
                <div class="empty-placeholder visage-missing-dependency">
                    <i class="visage-icon extension-off" style="width: 5rem;height: 5rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3 style="margin-bottom: 0.5rem; color: var(--visage-color-text-main);">{{localize "VISAGE.Editor.Effects.DependencyTitle"}}</h3>
                    <p style="max-width: 300px; line-height: 1.5;">{{localize "VISAGE.Editor.Effects.DependencyHint"}}</p>
                </div>
            {{/if}}
        </div>
    </div>

    {{!-- VIEW 2: THE INSPECTOR --}}
    <div class="visage-view view-inspector visage-scrollable">
        <input type="hidden" name="inspector.effectId" value="{{inspector.id}}">
        <header class="inspector-header">
            <button type="button" class="back-btn" data-action="closeEffectInspector">
                <i class="visage-icon back"></i>
            </button>
            <h4 class="inspector-title">
                {{#if (eq inspector.type 'ring')}}
                    {{localize "VISAGE.Editor.Tabs.Ring"}}
                {{else if (eq inspector.type 'light')}}
                    {{localize "VISAGE.Editor.Light.SettingsTitle"}}
                {{else}}
                    {{localize "VISAGE.Editor.Effects.SettingsTitle"}}
                {{/if}}
            </h4>
        </header>

        <fieldset class="visage-fieldset inspector-fieldset">
            
            {{!-- RING CONFIGURATION --}}
            {{#if (eq inspector.type 'ring')}}
                <div class="form-group">
                     <label>{{localize "VISAGE.RingConfig.RingColor"}}</label>
                    <div class="visage-form-fields">
                        <color-picker name="ringColor" value="{{ring.colors.ring}}"></color-picker>
                    </div>
                </div>
                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.BackgroundColor"}}</label>
                    <div class="visage-form-fields">
                        <color-picker name="ringBackgroundColor" value="{{ring.colors.background}}"></color-picker>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.SubjectTexture"}}</label>
                    <div class="visage-form-fields">
                         <file-picker type="image" name="ringSubjectTexture" value="{{this.ring.subject.texture}}"></file-picker>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{localize "VISAGE.RingConfig.SubjectScale"}}</label>
                    <div class="visage-form-fields">
                        <range-picker name="ringSubjectScale" value="{{ring.subject.scale}}" min="0.5" max="3.0" step="0.1"></range-picker>
                    </div>
                </div>

                <div class="form-group stacked">
                    <label>{{localize "VISAGE.RingConfig.Effects.Label"}}</label>
                    <div class="visage-form-fields effects-grid">
                        {{#each ring.effects}}
                        <label class="checkbox">
                            <input class="visage-checkbox" type="checkbox" name="effect_{{this.value}}" {{checked this.isActive}}>
                            {{localize this.label}}
                        </label>
                        {{/each}}
                    </div>
                </div>
            {{/if}}

            {{!-- LIGHT CONFIGURATION --}}
            {{#if (eq inspector.type 'light')}}
                <div class="form-group fade-grid">
                    <label>{{localize "VISAGE.Editor.Light.Dim"}}</label>
                    <input type="number" name="light.dim" value="{{light.dim}}" step="0.5">
                    <label>{{localize "VISAGE.Editor.Light.Bright"}}</label>
                    <input type="number" name="light.bright" value="{{light.bright}}" step="0.5">
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Light.Color"}}</label>
                    <div class="visage-form-fields">
                        <color-picker name="light.color" value="{{light.color}}"></color-picker>
                    </div>
                </div>

                <div class="form-group">
                     <label>{{localize "VISAGE.Editor.Light.ColorIntensity"}}</label>
                    <div class="visage-form-fields">
                        <div class="range-wrapper">
                            <input type="range" name="light.alpha" value="{{light.alpha}}" min="0" max="1" step="0.05" oninput="this.nextElementSibling.value = this.value">
                            <output class="value-display">{{light.alpha}}</output>
                        </div>
                    </div>
                </div>

                <hr class="visage-divider">

                <div class="form-group">
                    <label data-tooltip="{{localize 'VISAGE.Editor.Light.LuminosityHint'}}">
                        {{localize "VISAGE.Editor.Light.Luminosity"}}
                    </label>
                    <div class="visage-form-fields">
                        <div class="range-wrapper">
                            <input type="range" name="light.luminosity" value="{{light.luminosity}}" min="-1" max="1" step="0.05" oninput="this.nextElementSibling.value = this.value">
                            <output class="value-display">{{light.luminosity}}</output>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Light.Angle"}}</label>
                    <div class="visage-form-fields">
                         <div class="range-wrapper">
                            <input type="range" name="light.angle" value="{{light.angle}}" min="0" max="360" step="1" oninput="this.nextElementSibling.value = this.value">
                            <output class="value-display">{{light.angle}}°</output>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label data-tooltip="{{localize 'VISAGE.Editor.Light.PriorityHint'}}">{{localize "VISAGE.Editor.Light.Priority"}}</label>
                    <div class="visage-form-fields">
                         <input type="number" name="light.priority" value="{{light.priority}}" step="1" placeholder="0">
                    </div>
                </div>

                <hr class="visage-divider">

                <div class="form-group">
                     <label data-tooltip="{{localize 'VISAGE.Editor.Light.AnimationHint'}}">
                        {{localize "VISAGE.Editor.Light.AnimationType"}}
                    </label>
                    <div class="visage-form-fields">
                        <select name="light.animation.type">
                            {{selectOptions lightAnimationOptions selected=light.animation.type}}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Light.Speed"}}</label>
                    <div class="visage-form-fields">
                        <div class="range-wrapper">
                            <input type="range" name="light.animation.speed" value="{{light.animation.speed}}" min="1" max="10" step="1" oninput="this.nextElementSibling.value = this.value">
                            <output class="value-display">{{light.animation.speed}}</output>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Light.Intensity"}}</label>
                    <div class="visage-form-fields">
                        <div class="range-wrapper">
                            <input type="range" name="light.animation.intensity" value="{{light.animation.intensity}}" min="1" max="10" step="1" oninput="this.nextElementSibling.value = this.value">
                            <output class="value-display">{{light.animation.intensity}}</output>
                        </div>
                    </div>
                </div>
            {{/if}}

            {{!-- VISUAL/AUDIO EFFECT CONFIGURATION --}}
            {{#if (or (eq inspector.type 'visual') (eq inspector.type 'audio'))}}
                <div class="form-group">
                    <label>{{localize "VISAGE.GlobalEditor.Label"}}</label>
                    <div class="visage-form-fields">
                        <input type="text" name="effectLabel" value="{{inspector.label}}" placeholder="{{localize 'VISAGE.Editor.Effects.PathPlaceholder'}}">
                    </div>
                </div>

                <div class="form-group stacked">
                    <label>{{localize "VISAGE.Editor.Effects.Path"}}</label>
                    <div class="visage-form-fields">
                        <input type="text" name="effectPath" value="{{inspector.path}}" placeholder="e.g. jb2a.fire_bolt.red">
                        
                        <button type="button" data-action="openSequencerDatabase" data-tooltip="{{localize 'VISAGE.Editor.Effects.OpenDatabase'}}">
                            <i class="visage-icon library"></i>
                        </button>

                        <button type="button" class="file-picker-button" data-action="openFilePicker" data-tooltip="{{localize 'VISAGE.Editor.Effects.OpenFile'}}">
                            <i class="visage-icon open"></i>
                        </button>
                    </div>
                    <p class="hint">{{localize "VISAGE.Editor.Effects.DatabaseHint"}}</p>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Effects.Delay"}}</label>
                    <div class="visage-form-fields">
                        <input type="number" name="effectDelay" value="{{inspector.delay}}" step="0.1" placeholder="0">
                    </div>
                </div>
            {{/if}}

            {{!-- VISUAL SPECIFIC --}}
            {{#if (eq inspector.type 'visual')}}
                <div class="form-group">
                    <label>{{localize "VISAGE.Config.List.Scale"}}</label>
                    <div class="visage-form-fields">
                        <input type="number" name="effectScale" value="{{inspector.scale}}" step="10">
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Config.Opacity.Label"}}</label>
                    <div class="visage-form-fields">
                        <range-picker name="effectOpacity" value="{{inspector.opacity}}" min="0" max="1" step="0.1"></range-picker>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Effects.BlendMode"}}</label>
                    <div class="visage-form-fields">
                        <select name="effectBlendMode">
                            <option value="normal" {{visageSelected (eq inspector.blendMode "normal")}}>{{localize "VISAGE.BlendMode.Normal"}}</option>
                            <option value="screen" {{visageSelected (eq inspector.blendMode "screen")}}>{{localize "VISAGE.BlendMode.Screen"}}</option>
                            <option value="multiply" {{visageSelected (eq inspector.blendMode "multiply")}}>{{localize "VISAGE.BlendMode.Multiply"}}</option>
                            <option value="overlay" {{visageSelected (eq inspector.blendMode "overlay")}}>{{localize "VISAGE.BlendMode.Overlay"}}</option>
                            <option value="lighten" {{visageSelected (eq inspector.blendMode "lighten")}}>{{localize "VISAGE.BlendMode.Lighten"}}</option>
                            <option value="darken" {{visageSelected (eq inspector.blendMode "darken")}}>{{localize "VISAGE.BlendMode.Darken"}}</option>
                        </select>
                    </div>
                </div>

                <div class="form-group rotation-group">
                    <label>{{localize "VISAGE.Rotation.Label"}}</label>
                    <div class="visage-form-fields">
                        <input type="number" name="effectRotation" value="{{inspector.rotation}}" placeholder="0">
                        <label class="rotation-random-toggle">
                            <input type="checkbox" name="effectRotationRandom" class="visage-checkbox" {{checked inspector.rotationRandom}}>
                            {{localize "VISAGE.Random"}}
                        </label>
                    </div>
                </div>

                <hr class="visage-divider">

                <div class="form-group">
                    <label>{{localize "VISAGE.Editor.Effects.Layering"}}</label>
                    <div class="visage-form-fields">
                        <select name="effectZIndex">
                            <option value="above" {{visageSelected (eq inspector.zOrder "above")}}>{{localize "VISAGE.Editor.Effects.Above"}}</option>
                            <option value="below" {{visageSelected (eq inspector.zOrder "below")}}>{{localize "VISAGE.Editor.Effects.Below"}}</option>
                        </select>
                    </div>
                </div>
            {{/if}}

            {{!-- AUDIO SPECIFIC --}}
            {{#if (eq inspector.type 'audio')}}
                <div class="form-group fade-grid">
                    <label>{{localize "VISAGE.Editor.Effects.FadeIn"}}</label>
                    <input type="number" name="effectFadeIn" value="{{inspector.fadeIn}}" step="100" placeholder="0">
                    <label>{{localize "VISAGE.Editor.Effects.FadeOut"}}</label>
                    <input type="number" name="effectFadeOut" value="{{inspector.fadeOut}}" step="100" placeholder="0">
                </div>
                <div class="form-group checkbox-input-group" style="grid-template-columns: 1fr max-content max-content;">
                    <label>{{localize "VISAGE.Editor.Effects.Volume"}}</label>
                    <div class="visage-form-fields">
                        <range-picker name="effectVolume" value="{{inspector.opacity}}" min="0" max="1" step="0.1"></range-picker>
                    </div>
                </div>
            {{/if}}

        </fieldset>
    </div>
</div>